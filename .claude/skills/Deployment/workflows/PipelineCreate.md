# PipelineCreate Workflow

Create a CI/CD pipeline for a project that doesn't have one.

## When to Use

- New project needs CI/CD
- Migrating from manual deployments
- Setting up automated builds

## Workflow Steps

### Step 1: Detect Project Type

Examine project to determine stack:

```bash
# Check for indicators
ls package.json       # Node/Bun project
ls pyproject.toml     # Python project
ls go.mod            # Go project
ls Cargo.toml        # Rust project
ls Dockerfile        # Containerized
```

**Determine:**
- Runtime (Bun, Python, Go, etc.)
- Build requirements
- Test command
- Deployment target (Unraid, Cloudflare, K8s)

---

### Step 2: Create Pipeline Config

**For Bun/TypeScript + Docker + Unraid:**

```yaml
# .gitlab-ci.yml
# Generated by PAI Deployment skill

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Build Docker image
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Run tests
test:
  stage: test
  image: oven/bun:latest
  script:
    - bun install
    - bun test
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_ID

# Deploy to Unraid (manual trigger)
deploy:unraid:
  stage: deploy
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$UNRAID_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$UNRAID_HOST_KEY" >> ~/.ssh/known_hosts
  script:
    - |
      ssh root@$UNRAID_HOST << ENDSSH
        # Login to registry
        echo "${CI_REGISTRY_PASSWORD}" | docker login -u ${CI_REGISTRY_USER} --password-stdin ${CI_REGISTRY}

        # Pull and deploy
        docker pull ${CI_REGISTRY_IMAGE}:latest
        docker stop [APP_NAME] || true
        docker rm [APP_NAME] || true
        docker run -d \\
          --name [APP_NAME] \\
          --restart unless-stopped \\
          -p [PORT]:[PORT] \\
          -v /mnt/user/appdata/[APP_NAME]/config:/app/config:ro \\
          -v /mnt/user/appdata/[APP_NAME]/data:/app/data \\
          -e TZ=America/New_York \\
          ${CI_REGISTRY_IMAGE}:latest

        docker ps | grep [APP_NAME]
      ENDSSH
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: production
```

**For Python + Docker:**

```yaml
# Build
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG

# Test
test:
  stage: test
  image: python:3.11
  before_script:
    - pip install uv
    - uv pip install -e ".[dev]"
  script:
    - pytest --cov
```

**For Next.js + Cloudflare Pages:**

```yaml
# Delegate to Cloudflare skill
# Uses wrangler for deployment
deploy:cloudflare:
  stage: deploy
  image: node:20
  script:
    - npm install -g wrangler
    - wrangler pages deploy out --project-name=$PROJECT_NAME
```

---

### Step 3: Configure CI/CD Variables

**Required variables for Unraid deployment:**

| Variable | Description | Protected | Masked |
|----------|-------------|-----------|--------|
| UNRAID_HOST | Server IP | Yes | No |
| UNRAID_SSH_KEY | Private SSH key | Yes | Yes |
| UNRAID_HOST_KEY | SSH host key | Yes | No |

**How to obtain:**

```bash
# Get host key
ssh-keyscan -t ed25519 $UNRAID_HOST

# Generate SSH key (if needed)
ssh-keygen -t ed25519 -f unraid_deploy_key -N ""
# Add public key to Unraid: /root/.ssh/authorized_keys
```

**Delegate to:** Secrets skill for configuration

---

### Step 4: Create Dockerfile (if needed)

**For Bun/TypeScript:**

```dockerfile
FROM oven/bun:1 AS builder
WORKDIR /app
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile
COPY . .
RUN bun run build

FROM oven/bun:1-slim
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./
EXPOSE 3000
CMD ["bun", "run", "start"]
```

---

### Step 5: Commit and Push

```bash
git add .gitlab-ci.yml Dockerfile
git commit -m "Add CI/CD pipeline

- GitLab CI/CD for build, test, deploy
- Docker containerization
- Unraid deployment target

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

git push origin main
```

---

### Step 6: Verify Pipeline Runs

After push, verify pipeline triggers:

```bash
# Check pipeline status
curl -s "https://gitlab.com/api/v4/projects/[ID]/pipelines?ref=main" \
  -H "PRIVATE-TOKEN: $GITLAB_TOKEN" | jq '.[0]'
```

Wait for first run to complete (build + test stages).

---

## Pipeline Templates

| Project Type | Template |
|--------------|----------|
| Bun + Docker + Unraid | Standard (above) |
| Python + Docker + Unraid | Python variant |
| Next.js + Cloudflare | Cloudflare Pages |
| Static site | Simple build + deploy |

---

## Output

After PipelineCreate:
- `.gitlab-ci.yml` created and committed
- `Dockerfile` created (if needed)
- CI/CD variables documented
- First pipeline running

---

**PipelineCreate ensures every project has proper CI/CD from day one.**
